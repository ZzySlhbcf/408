# 5.4.1 控制器的结构和功能

![[计算机硬件系统的五大功能及其连接关系.png]]

1. 运算器部件通过数据总线与内存储器、输入设备和输出设备传送数据
2. 输入设备和输出设备通过接口电路与总线相连接
3. 内存储器、输入设备和输出设备从地址总线接收地址信息, 从控制总线得到控制信号, 通过数据总线与其他部件传送数据
4. 控制器部件从数据总线接收指令信息, 从运算器部件接收指令转移地址, 送出指令地址到地址总线, 还要向系统中的部件提供它们运行所需要的控制信号

控制器是计算机系统的指挥中心, 控制器的主要功能有: 
1. 从主存中取出一条指令, 并指出下一条指令在主存中的位置
2. 对指令进行译码或测试, 产生相应的操作控制信号, 以便启动规定的动作
3. 指挥并控制CPU、主存、输入设备和输出设备之间的数据流动方向

根据控制器产生微操作控制信号的方式的不同，控制器可分为硬布线控制器和微程序控制器
两类控制器中的PC和IR是相同的，但确定和表示指令执行步骤的办法及给出控制各部件运行所需要的控制信号的方案是不同的
# 5.4.2 硬布线控制器

> 由复杂的组合逻辑门电路和触发器构成, 也称**组合逻辑控制器**
> 根据指令的要求、当前的时序及内外部的状态, 按时间的顺序发送一系列位操作控制信号

![[带指令译码器和节拍输入的简化的控制单元框图.png]]

控制单元（CU）的输入信号来源如下：
1. **经指令译码器译码产生的指令信息**
   它与时钟配合产生不同的控制信号
2. 时钟脉冲, **其频率为机器的主频**
   它使CU能够按一定的节拍发出各个控制信号
3. 来自执行单元的反馈信息即标志
   CU有时需依赖CPU当前的状态来产生控制信号

节拍发生器产生各时钟周期中的节拍信号, 使不同的微操作命令按时间的先后发出
个别指令的操作不仅受操作码控制, 而且还受状态标志控制, 因此CU的输入来自**操作码译码电路、节拍发生器及状态标志**, 其输出到**CPU内部或外部控制总线上**

硬布线控制的功能由逻辑门组合实现, **其速度主要取决于电路延迟**, 因此高速计算机中的关键核心部件**CPU往往采用硬布线逻辑实现**. 因此, RISC一般都选用硬布线控制器

硬布线控制器的控制信号先用逻辑式列出, 经化简后用电路来实现, 因此显得零乱复杂, **当需要修改或增加指令时就必须重新设计电路**. **而且指令系统功能越全，微操作命令就越多，电路也就越庞杂，调试就更困难**

# 5.4.3 微程序控制器

## 微程序控制的基本概念

> 将每条机器指令编写成一个微量程序, 每个微程序包括若干微指令, 每条微指令对应一个或几个微操作的过程

1. 微命令与微操作: **控制部件向执行部件发出的各种控制命令**, 是构成控制序列的最小单位
   微命令有相容性和互斥性: 相容性微命令是指那些可以同时出现、共同完成某一些微操作的微命令; 互斥微命令则相反
2. 微指令与微周期: 微命令->微指令, 微周期为取出并执行一条微指令所需的全部时间, 通常为一个时钟周期
   + 操作控制字短: 微操作码字段, 产生某一步操作所需的各种操作控制信号
   + 顺序控制字段: 微地址码字段, 产生下一条要执行的微指令地址
![[微指令与微命令.png]]
1. 主存储器与控制存储器
   主存用于存放程序和数据, **在CPU外部, 用RAM**
   控制存储器CM用于存放微程序, **在CPU内部, 用ROM实现**
   存放微指令的控制存储器的单元地址称为微地址
2. 程序与微程序: 程序是指令的有序集合, 微程序是微指令的有序集合

>[!info] 执行一个机器指令的过程就是执行一个微程序的过程
>微程序的思想就是将每条机器指令编写成一个微程序, 每个微程序包含若干个微指令, 每个微指令对应一个或几个微命令

+ 地址寄存器 MAR: 存放主存的读写地址
+ 微指令地址寄存器 CMAR: 存放待执行的微指令在控制存储器中的微地址
+ 指令寄存器IR: 用于存放从主存中读出的指令
+ 微指令寄存器 CMDR: 用于存放从控制存储器中读出的微指令

## 微程序控制器的组成和工作过程

### 微程序控制器的基本组成

1. 起始和转移地址形成部件 (简称微地址形成部件): 用于产生初始和后继微地址，以保证微指令的连续执行
2. 微指令地址寄存器: 接收微地址形成部件送来的微地址, 为读取微指令做准备
3. 控制存储器, 它是微程序控制器的核心部件: 用于存放各指令对应的微程序
4. 微指令寄存器: 其位数等于**微指令字长**

![[微程序控制器的基本结构.png]]

### 微程序控制器的工作过程

1. 执行取指令公共操作: 在机器开始运行时, 自动地将取指微程序的入口地址送入μPC, 并从CM中读出相应的微指令并送入μIR
   取指微程序的入口地址一般为CM的O号单元, 取指微程序执行完成后, 从主存中取出的机器指令就已存入指令寄存器中
   >[!info] 形成微程序入口地址的是**机器指令的操作码字段**
2. 由机器指令的操作码字段通过微地址形成部件产生该机器指令所对应的微程序的入口地址, 送入μPC
3. **从CM中逐条取出对应的微指令并执行**
   >[!info] 控制存储器是ROM, 每次从CM中读取微指令需要时间, 因此比硬布线控制器慢
4. 执行完对应于一条机器指令的一个微程序后, 又回到取指微程序的入口地址, 继续第1步, 以完成取下一条机器指令的公共操作


### 微程序和机器指令

通常, 一条机器指令对应一个微程序
**任何机器指令的取指令操作都是相同的**, 因此可将取指令操作的微命令统一编成一个微程序, 这个微程序只负责将指令从主存单元中取出并送至指令寄存器。
此外, 也可编写出对应间址周期的微程序和中断周期的微程序

**控制存储器中的微程序个数应为机器指令数再加上对应取指、间址和中断周期等公共的微程序数**

## 微指令的编码方式

### 直接编码方式

+ 简单、直观、执行速度块, 操作并行性好
+ 微指令字长过长, n个微命令就要求微指令的操作字短有n位, 控制存储器的容量极大

### 字段直接编码方式

控制字段分为若干小字段, 把互斥微命令放在同一字段中, 相容性放在不同字段中, 每个字段独立编码

1. 互斥性微命令分在同一段内, 相容性微命令分在不同段内
2. 每个小段中包含的信息位不能太多, 否则将增加译码电路的复杂性和译码时间。
3. 一般每个小段还要留出一个状态, 表示本字段不发出任何微命令
   因此，当某字段的长度为3位时, 最多只能表示7个互斥的微命令, 通常用000表示不操作

### 字段间接编码方式

一个字段的某些微命令需由另一个字段中的某些微命令来解释, 因为不是靠字段直接译码发出的微命令，所以称为字段间接编码, 也称隐式编码。

这种方式可进一步缩短微指令字长，但因削弱了微指令的并行控制能力, 因此通常作为**字段直接编码方式**的一种辅助手段

## 微指令的地址形成方式

1. 由微指令的后继地址字段 (也称下地址字段)指出
   在微指令格式中设置一个后继地址字段, 由微指令的后继地址字段直接指出后继微指令的地址, 这种方式也称**断定方式**
2. 根据机器指令的操作码形成
   当机器指令取自指令寄存器后, 微指令的地址由操作码经微地址形成部件形成，该部件输出的是对应机器指令微程序的首地址。
3. 增量计数器法
   即(μPC)+1→μPC，适用于**后继微指令地址是连续的情况**
4. 根据各种标志决定下一条微指令分支转移的地址
5. 由硬件直接产生微程序入口地址
   电源加电后, 第一条微指令的地址可由专门的硬件电路产生, 并送至μPC, 这个地址即为取指周期微程序的入口地址

## 微指令的格式

![[水平型微指令的基本格式.png]]

+ 微程序短, 并行能力强, 执行速度快
+ 微指令长, 编写微程序比较麻烦

![[垂直型微指令的基本格式.png]]

+ 微指令短、简单、规整, 便于编写微程序
+ 微程序长, 执行速度慢, 效率低


| 水平型微指令                    | 垂直性微指令                   |
| ------------------------- | ------------------------ |
| 水平型微指令并行操作能力强、效率高、灵活性强    | 垂直型微指令则较差                |
| 水平型微指令执行一条指令的时间短          | 垂直型微指令执行的时间长             |
| 用水平型微指令编写的微程序，微指令字较长但微程序短 | 垂直型微指令正好相反               |
| 水平型微指令难以掌握                | 而垂直型微指令与机器指令比较相似, 相对容易掌握 |

## 硬布线和微程序的特点

![[微程序控制器和硬布线控制器的对比.png]]