# 5.5.1 异常和中断的基本概念

**由CPU内部产生的意外事件被称为异常**
由来自CPU外部的设备向CPU发出的中断请求被称为中断, 通常用于信息的输入和输出, 也称外中断
异常是CPU执行一条指令时, **由CPU在其内部检测到的**、与正在执行的指令相关的同步事件

中断是一种典型的由外部设备触发的、与当前正在执行的指令无关的异步事件

异常和中断处理过程的描述如下：
1. 若CPU在执行用户程序的第i条指令时检测到一个异常事件, 或者执行第i条指令后发现一个中断请求信号, 则CPU打断当前程序
2. 然后转去执行相应的异常或中断处理程序
   + 若异常或中断处理程序能够解决相应的问题, 则在异常或中断处理程序的最后, CPU通过执行异常或中断返回指令, 回到被打断的用户程序的第i条指令或第i+1条指令继续执行
   + 若异常或中断处理程序发现是不可恢复的致命错误, 则终止用户程序

通常情况下, **对异常和中断的具体处理过程由操作系统(和驱动程序)完成**。

>[!info] 异常和中断的处理过程基本是相同的，这也是有些教材将两者统称为单断的原因

# 5.5.2 异常和中断的分类

中断和异常在本质上是一样的, 但它们之间有以下两个重要的不同点: 
1. "缺页"或"溢出"等异常事件是由特定指令在执行过程中产生的, 而中断不和任何指令相关联, 也不阻止任何指令的完成
2）异常的检测由CPU自身完成，不必通过外部的某个信号通知CPU。对于中断，CPU必
须通过中断请求线获取中断源的信息，才能知道哪个设备发生了何种中断。
注 意
所有的异常和中断事件都是由硬件检测发现的。
此外，根据识别中断服务程序地址的方式，可分为向量中断和非向量中断；根据中断处理过
程是否允许被打断，还可分为单重中断和多重中断。
553异常和中断响应过程

![[内部异常和外部异常.png]]

## 异常的分类

异常是由CPU内部产生的意外事件, 分为**硬故障中断和程序性异常**
+ 硬故障中断: 由硬连线出现异常引起的, 如存储器校验错、总线错误等
+ 程序性异常也称软件中断, 是指在CPU内部因执行指令而引起的异常事件
  如**整除0、溢出、断点、单步跟踪、非法指令、栈溢出、地址越界、缺页等**
  按异常发生原因和返回方式的不同, 可分为故障、自陷和终止
### 故障(Fault)

指在引起故障的指令启动后、执行结束前被检测到的异常事件
1. 指令译码时，出现“非法操作码”
2. 取数据时，发生“缺段”或“缺页”
3. 执行整数除法指令时，发现"除数为0"

对于“缺段”“缺页”等异常事件, 经处理后, 可将所需的段或页面从磁盘调入主存, 回到发生故障的指令继续执行, **断点为当前发生故障的指令**
对于"非法操作码""除数为0"等，因为无法通过异常处理程序恢复故障, 因此不能回到原断点执行，必须终止进程的执行

### 自陷(Trap)

> 自陷也称陷阱或陷入, 它是**预先安排的一种"异常"事件**, 就像预先设定的“陷阱”一样。

在x86机器中, 用于程序调试"**断点设置**"和**单步跟踪的功能**就是通过陷阱机制实现的
此外, **系统调用指令、条件自陷指令(如MIPs中的 teq、teqi、tne、tnei等)** 等都属于陷阱指令，执行到这些指令时, 无条件或有条件地自动调出操作系统内核程序进行执行

**故障异常和自陷异常属于程序性异常(软件中断)**
### 终止(Abort)

执行指令的过程中发生了使**计算机无法继续执行的硬件故障**, 如控制器出错、存储器校验错、总线错误等, 则程序将无法继续执行,, 只能终止
此时, **调出异常服务程序来重启系统**

这种异常与故障和自陷不同，**不是由特定指令产生的, 而是随机发生的**
**终止异常和外中断属于硬件中断**

## 中断的分类

>中断是指来自CPU外部、与**CPU执行指令无关的事件引起的中断**, 包括I/O设备发出的I/O中断 (如键盘输入、打印机缺纸等), 或发生某种特殊事件(如用户按Esc键、定时器计数时间到)等
>
>外部I/O设备通过特定的中断请求信号线向CPU提出中断请求, CPU每执行完一条指令就检查中断请求信号线

1. 可屏蔽中断: 通过可屏蔽中断请求线INTR向CPU发出的中断请求
   CPU可以通过在中断控制器中设置相应的屏蔽字来屏蔽它或不屏蔽它
2. 不可屏蔽中断: 通过专门的不可屏蔽中断请求线NMI向CPU发出的中断请求
   通常是非常紧急的硬件故障, 如电源掉电等
   这类中断请求信号不可被屏蔽, 以让CPU快速处理这类紧急事件

# 5.5.3 异常和中断的响应过程

CPU执行指令时，若发生了异常或中断请求，则必须进行相应的处理。从CPU检测到异常或中断事件，到调出相应的处理程序，整个过程称为异常和中断响应。CPU对异常和中断响应的
过程可分为关中断、保存断点和程序状态、识别异常和中断并转到相应的处理程序。

1. 关中断: 在保存断点和程序状态期间, 不能被新的中断打断, 因此要禁止响应新的中断, 即关中断
   通常通过设置"中断允许"(IF)触发器来实现, 若IF置为1, 则为开中断, 表示允许响应中断; 若IF置为0，则表示关中断, 表示不允许响应中断
2. 保存断点和程序状态: 为了能在异常和中断处理后正确返回到被中断的程序继续执行, 必须将程序的断点
   返回地址送到栈或特定寄存器中, 通常保存在栈中, 这是为了支持异常或中断的嵌套
   异常和中断处理后可能还要回到被中断的程序继续执行, **被中断时的程序状态字寄存器PSW的内容也需要保存在栈或特定寄存器中**, 在异常和中断返回时恢复到PSW中
3. 识别异常和中断并转到相应的处理程序异常和中断源的识别有软件识别和硬件识别两种方式: **异常大多采用软件识别方式，而中断可以采用软件识别方式或硬件识别方式**
   软件识别方式是指CPU设置一个异常状态寄存器, 用于记录异常原因
   整个中断处理过程是由软/硬件协同实现的